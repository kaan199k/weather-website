<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Weather</title>
  <meta name="description" content="Fast, simple weather app using the free Open-Meteo API (no key required)." />
  <link rel="preconnect" href="https://api.open-meteo.com" crossorigin>
  <link rel="preconnect" href="https://geocoding-api.open-meteo.com" crossorigin>
  <style>
    :root{
      --bg:#0b1020; --card:#111735; --muted:#98a2b3; --text:#e6eaf2; --accent:#6ea8fe; --accent-2:#b69bff; --danger:#ff6b6b; --input:#0f1530;
      --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f3f5fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --accent:#2563eb; --accent-2:#7c3aed; --danger:#dc2626; --input:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--text);
      background: radial-gradient(1200px 600px at 80% -10%, color-mix(in oklab, var(--accent) 25%, transparent), transparent 60%),
                  radial-gradient(1200px 600px at -10% 110%, color-mix(in oklab, var(--accent-2) 20%, transparent), transparent 60%),
                  var(--bg);
      display:grid; place-items:center; padding:24px; transition: background .3s ease, color .3s ease;
    }
    .app{ width:100%; max-width:820px; background:linear-gradient(180deg, color-mix(in oklab, #fff 4%, transparent), color-mix(in oklab, #fff 2%, transparent)); backdrop-filter: blur(10px); border:1px solid color-mix(in oklab, #fff 8%, transparent); border-radius: var(--radius); box-shadow: 0 30px 60px rgba(0,0,0,.35); overflow:hidden; }
    header{padding:26px 24px 0; display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .control-btn{ padding:10px 12px; border:none; border-radius:12px; font-weight:600; cursor:pointer; font-size:14px; background: var(--input); color:var(--text); border:1px solid color-mix(in oklab, #000 10%, #fff 10%); }
    .control-select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      padding:10px 12px; border-radius:12px; font-weight:700; font-size:14px; background:var(--input); color:var(--text);
      border:1px solid color-mix(in oklab, #000 10%, #fff 10%); cursor:pointer;
    }
    .search{display:flex; gap:10px; padding:16px 24px 24px}
    input[type="text"]{ flex:1; background:var(--input); color:var(--text); border:1px solid color-mix(in oklab, #000 10%, #fff 10%); border-radius:12px; padding:14px 16px; outline:none; font-size:16px; }
    #go{padding:14px 16px; border:none; border-radius:12px; font-weight:600; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1020}
    #locate{padding:14px 16px; border:none; border-radius:12px; font-weight:600; background: var(--input); color:var(--text); border:1px solid color-mix(in oklab, #000 10%, #fff 10%)}
    .content{display:grid; gap:16px; padding:0 24px 24px}
    .card{background:color-mix(in oklab, #fff 3%, transparent); border:1px solid color-mix(in oklab, #fff 8%, transparent); border-radius:16px; padding:18px}
    .current{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .city{font-size:18px; opacity:.9}
    .temp{font-size:56px; font-weight:700; line-height:1}
    .meta{display:flex; gap:14px; flex-wrap:wrap; opacity:.9}
    .emoji{font-size:42px}
    .row{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    .kv{display:flex; align-items:center; gap:10px}
    .error{color:var(--danger); font-weight:600}
    .muted{color:var(--muted)}
    .loader{width:18px; height:18px; border:3px solid color-mix(in oklab, #fff 35%, transparent); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:600px){
      body{display:block; padding:16px; min-height:100dvh;}
      .app{max-width:100%; border-radius:14px;}
      header{padding:18px 16px 0;}
      .search{flex-direction:column; gap:8px; padding:12px 16px 16px;}
      #go,#locate{width:100%; padding:16px; font-size:16px;}
      .row{grid-template-columns:1fr 1fr;}
    }
    @media (max-width:380px){.row{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Quick Weather App">
    <header>
      <h1 id="title">Quick Weather</h1>
      <div class="controls">
        <button id="unitToggle" class="control-btn" title="Toggle ¬∞C/¬∞F">¬∞C</button>
        <button id="themeToggle" class="control-btn" title="Toggle dark/light">Dark</button>
        <select id="langSelect" class="control-select" aria-label="Language">
          <option value="en">EN</option>
          <option value="bg">BG</option>
        </select>
      </div>
    </header>

    <div class="search" role="search">
      <input id="city" type="text" placeholder="Search city... e.g. Sofia, Rome, Berlin" autocomplete="off" aria-label="City name" />
      <button id="go">Get Weather</button>
      <button id="locate" title="Use my location">Use My Location</button>
    </div>

    <section class="content" id="content" aria-live="polite">
      <div class="muted" id="hint">Type a city and press <strong>Get Weather</strong>, or click <strong>Use My Location</strong>.</div>
    </section>
  </div>

  <script>
  // --- Elements & state
  const cityInput=document.getElementById('city');
  const goBtn=document.getElementById('go');
  const locateBtn=document.getElementById('locate');
  const content=document.getElementById('content');
  const unitToggle=document.getElementById('unitToggle');
  const themeToggle=document.getElementById('themeToggle');
  const langSelect=document.getElementById('langSelect');
  const titleEl=document.getElementById('title');
  const hintEl=document.getElementById('hint');
  const htmlEl=document.documentElement;

  let unit=localStorage.getItem('unit')||'C';
  let theme=localStorage.getItem('theme')||'dark';
  let lang=localStorage.getItem('lang')||((navigator.language||'en').startsWith('bg')?'bg':'en');
  let lastData=null;

  // --- i18n dictionaries
  const i18n={
    en:{
      title:'Quick Weather',
      search_ph:'Search city... e.g. Sofia, Rome, Berlin',
      get_weather:'Get Weather',
      use_location:'Use My Location',
      hint:'Type a city and press <strong>Get Weather</strong>, or click <strong>Use My Location</strong>.',
      looking_up: c=>`Looking up ‚Äú${escapeHTML(c)}‚Äù‚Ä¶ <span class="loader"></span>`,
      fetching_loc:'Fetching weather for your location‚Ä¶ <span class="loader"></span>',
      try_ip:'Trying approximate location via IP‚Ä¶ <span class="loader"></span>',
      ip_unavail:'IP location unavailable.',
      could_not_detect:'Could not detect location.',
      valid_city:'Please enter a valid city.',
      geocode_fail:'Geocoding failed.',
      city_not_found:'City not found. Try a different name.',
      wx_fail:'Weather request failed.',
      feels:'Feels', humidity:'Humidity', precip:'Precip', wind:'Wind', direction:'Direction', coords:'Coords',
      light:'Light', dark:'Dark',
      codes:{
        0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Fog',48:'Rime fog',
        51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',56:'Freezing drizzle',57:'Freezing drizzle',
        61:'Light rain',63:'Rain',65:'Heavy rain',66:'Freezing rain',67:'Freezing rain',
        71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',
        80:'Rain showers',81:'Heavy showers',82:'Violent showers',85:'Snow showers',86:'Heavy snow showers',
        95:'Thunderstorm',96:'Thunder w/ hail',99:'Thunder w/ hail'
      }
    },
    bg:{
      title:'–ë—ä—Ä–∑–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞',
      search_ph:'–¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –≥—Ä–∞–¥‚Ä¶ –Ω–∞–ø—Ä. –°–æ—Ñ–∏—è, –†–∏–º, –ë–µ—Ä–ª–∏–Ω',
      get_weather:'–í–∏–∂ –≤—Ä–µ–º–µ—Ç–æ',
      use_location:'–ò–∑–ø–æ–ª–∑–≤–∞–π –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ—Ç–æ',
      hint:'–í—ä–≤–µ–¥–∏ –≥—Ä–∞–¥ –∏ –Ω–∞—Ç–∏—Å–Ω–∏ <strong>–í–∏–∂ –≤—Ä–µ–º–µ—Ç–æ</strong> –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ <strong>–ò–∑–ø–æ–ª–∑–≤–∞–π –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ—Ç–æ</strong>.',
      looking_up: c=>`–¢—ä—Ä—Å—è ‚Äû${escapeHTML(c)}‚Äú‚Ä¶ <span class="loader"></span>`,
      fetching_loc:'–ó–∞—Ä–µ–∂–¥–∞–º –ø—Ä–æ–≥–Ω–æ–∑–∞ –∑–∞ —Ç–≤–æ–µ—Ç–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶ <span class="loader"></span>',
      try_ip:'–û–ø–∏—Ç–≤–∞–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª–Ω–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP‚Ä¶ <span class="loader"></span>',
      ip_unavail:'–£—Å–ª—É–≥–∞—Ç–∞ –∑–∞ IP –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –µ –Ω–µ–¥–æ—Å—Ç—ä–ø–Ω–∞.',
      could_not_detect:'–ù–µ —É—Å–ø—è—Ö –¥–∞ –æ—Ç–∫—Ä–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.',
      valid_city:'–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–µ–Ω –≥—Ä–∞–¥.',
      geocode_fail:'–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ –Ω–∞ –≥—Ä–∞–¥.',
      city_not_found:'–ì—Ä–∞–¥—ä—Ç –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω. –û–ø–∏—Ç–∞–π –¥—Ä—É–≥–æ –∏–º–µ.',
      wx_fail:'–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—è–≤–∫–∞—Ç–∞ –∑–∞ –≤—Ä–µ–º–µ—Ç–æ.',
      feels:'–£—Å–µ—â–∞ —Å–µ', humidity:'–í–ª–∞–∂–Ω–æ—Å—Ç', precip:'–í–∞–ª–µ–∂–∏', wind:'–í—è—Ç—ä—Ä', direction:'–ü–æ—Å–æ–∫–∞', coords:'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏',
      light:'–°–≤–µ—Ç—ä–ª', dark:'–¢—ä–º–µ–Ω',
      codes:{
        0:'–Ø—Å–Ω–æ –Ω–µ–±–µ',1:'–ü—Ä–µ–¥–∏–º–Ω–æ —è—Å–Ω–æ',2:'–†–∞–∑–∫—ä—Å–∞–Ω–∞ –æ–±–ª–∞—á–Ω–æ—Å—Ç',3:'–û–±–ª–∞—á–Ω–æ',45:'–ú—ä–≥–ª–∞',48:'–ú—Ä–∞–∑–æ–≤–∏—Ç–∞ –º—ä–≥–ª–∞',
        51:'–°–ª–∞–± —Ä—ä–º–µ–∂',53:'–†—ä–º–µ–∂',55:'–°–∏–ª–µ–Ω —Ä—ä–º–µ–∂',56:'–õ–µ–¥–µ–Ω —Ä—ä–º–µ–∂',57:'–õ–µ–¥–µ–Ω —Ä—ä–º–µ–∂',
        61:'–°–ª–∞–± –¥—ä–∂–¥',63:'–î—ä–∂–¥',65:'–°–∏–ª–µ–Ω –¥—ä–∂–¥',66:'–õ–µ–¥–µ–Ω –¥—ä–∂–¥',67:'–õ–µ–¥–µ–Ω –¥—ä–∂–¥',
        71:'–°–ª–∞–± —Å–Ω—è–≥',73:'–°–Ω—è–≥',75:'–°–∏–ª–µ–Ω —Å–Ω—è–≥',77:'–°–Ω–µ–∂–Ω–∏ –∑—Ä—ä–Ω—Ü–∞',
        80:'–ü—Ä–µ–≤–∞–ª—è–≤–∞–Ω–∏—è –æ—Ç –¥—ä–∂–¥',81:'–°–∏–ª–Ω–∏ –ø—Ä–µ–≤–∞–ª—è–≤–∞–Ω–∏—è',82:'–ë—É—Ä–Ω–∏ –ø—Ä–µ–≤–∞–ª—è–≤–∞–Ω–∏—è',
        85:'–ü—Ä–µ–≤–∞–ª—è–≤–∞–Ω–∏—è –æ—Ç —Å–Ω—è–≥',86:'–°–∏–ª–Ω–∏ –ø—Ä–µ–≤–∞–ª—è–≤–∞–Ω–∏—è –æ—Ç —Å–Ω—è–≥',
        95:'–ì—Ä—ä–º–æ—Ç–µ–≤–∏—á–Ω–∞ –±—É—Ä—è',96:'–ë—É—Ä—è —Å –≥—Ä–∞–¥—É—à–∫–∞',99:'–ë—É—Ä—è —Å –≥—Ä–∞–¥—É—à–∫–∞'
      }
    }
  };

  // --- Weather icons stay the same across languages
  const iconMap={
    0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',
    51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',56:'ü•∂',57:'ü•∂',
    61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',66:'ü•∂',67:'ü•∂',
    71:'üå®Ô∏è',73:'üå®Ô∏è',75:'‚ùÑÔ∏è',77:'‚ùÑÔ∏è',80:'üå¶Ô∏è',81:'üåßÔ∏è',82:'‚õàÔ∏è',
    85:'üå®Ô∏è',86:'‚ùÑÔ∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'
  };

  // --- Helpers
  function t(key){ return i18n[lang][key] ?? i18n.en[key] ?? key; }
  function codeText(code){ return (i18n[lang].codes[code] ?? i18n.en.codes[code] ?? ''); }
  function escapeHTML(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));}
  const cToF=c=>c*9/5+32;
  function formatTemp(c){ return unit==='C' ? Math.round(c)+'¬∞C' : Math.round(cToF(c))+'¬∞F'; }
  const degToCompass=d=>['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(d/22.5)%16];

  function applyTheme(){
    htmlEl.setAttribute('data-theme', theme);
    themeToggle.textContent = theme==='dark' ? t('dark') : t('light'); // show CURRENT theme
  }
  function applyUnit(){
    unitToggle.textContent = unit==='C' ? '¬∞C' : '¬∞F';
    if(lastData) renderCurrent(lastData);
  }
  function applyLang(){
    htmlEl.setAttribute('lang', lang);
    titleEl.textContent = t('title');
    cityInput.placeholder = t('search_ph');
    goBtn.textContent = t('get_weather');
    locateBtn.textContent = t('use_location');
    hintEl.innerHTML = t('hint');
    // refresh current card if exists
    if(lastData) renderCurrent(lastData);
  }

  function setStatus(html){ content.innerHTML = `<div class="card muted">${html}</div>`; }

  async function fetchAndRender({lat,lon,label}){
    const wxURL=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m&timezone=auto`;
    const wxRes=await fetch(wxURL);
    if(!wxRes.ok) throw new Error(t('wx_fail'));
    const wx=await wxRes.json();
    const d={
      city:label,tz:wx.timezone_abbreviation,
      t:wx.current.temperature_2m,feels:wx.current.apparent_temperature,
      rh:wx.current.relative_humidity_2m,wc:wx.current.weather_code,
      wind:wx.current.wind_speed_10m,windd:wx.current.wind_direction_10m,
      precip:wx.current.precipitation,lat,lon
    };
    lastData=d; renderCurrent(d);
  }

  async function fetchWeatherByCity(city){
    if(!city || city.trim().length<2) throw new Error(t('valid_city'));
    setStatus(t('looking_up')(city));
    const geoURL=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=${lang==='bg'?'bg':'en'}&format=json`;
    const r=await fetch(geoURL);
    if(!r.ok) throw new Error(t('geocode_fail'));
    const j=await r.json();
    if(!j.results?.length) throw new Error(t('city_not_found'));
    const g=j.results[0];
    const label=`${g.name}${g.admin1?', '+g.admin1:''}${g.country?', '+g.country:''}`;
    await fetchAndRender({lat:g.latitude,lon:g.longitude,label});
    localStorage.setItem('lastCity', g.name);
  }

  async function fetchWeatherByCoords(lat,lon){
    setStatus(t('fetching_loc'));
    let label = lang==='bg' ? '–¢–≤–æ–µ—Ç–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ' : 'Your location';
    try{
      const rev=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=${lang==='bg'?'bg':'en'}&format=json`);
      if(rev.ok){
        const j=await rev.json();
        if(j.results?.[0]){
          const r=j.results[0];
          label=`${r.name||label}${r.admin1?', '+r.admin1:''}${r.country?', '+r.country:''}`;
        }
      }
    }catch{}
    await fetchAndRender({lat,lon,label});
  }

  function renderCurrent(d){
    const emoji = iconMap[d.wc] || '‚ùì';
    const desc = codeText(d.wc) || (lang==='bg'?'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ':'Unknown');
    content.innerHTML = `
      <div class="card current">
        <div>
          <div class="city">${escapeHTML(d.city)}</div>
          <div class="temp">${formatTemp(d.t)}</div>
          <div class="meta"><span>${desc}</span><span>¬∑</span><span>${d.tz}</span></div>
        </div>
        <div class="emoji" aria-label="${desc}">${emoji}</div>
      </div>
      <div class="row">
        <div class="card kv"><strong>${t('feels')}</strong> ${formatTemp(d.feels)}</div>
        <div class="card kv"><strong>${t('humidity')}</strong> ${Math.round(d.rh)}%</div>
        <div class="card kv"><strong>${t('precip')}</strong> ${d.precip?.toFixed ? d.precip.toFixed(1) : d.precip} mm</div>
        <div class="card kv"><strong>${t('wind')}</strong> ${Math.round(d.wind)} km/h</div>
        <div class="card kv"><strong>${t('direction')}</strong> ${degToCompass(d.windd)} (${Math.round(d.windd)}¬∞)</div>
        <div class="card kv"><strong>${t('coords')}</strong> ${d.lat.toFixed(2)}, ${d.lon.toFixed(2)}</div>
      </div>`;
  }

  async function ipFallback(){
    try{
      setStatus(t('try_ip'));
      const res=await fetch('https://ipapi.co/json/');
      if(!res.ok) throw new Error(t('ip_unavail'));
      const j=await res.json();
      if(!j.latitude||!j.longitude) throw new Error(t('could_not_detect'));
      await fetchWeatherByCoords(j.latitude,j.longitude);
    }catch(e){
      content.innerHTML = `<div class="card error">${escapeHTML(e.message)}</div>`;
    }
  }

  // --- Events
  locateBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation) return content.innerHTML = `<div class="card error">${lang==='bg'?'–ë—Ä–∞—É–∑—ä—Ä—ä—Ç –Ω–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è.':'Geolocation not supported.'}</div>`;
    navigator.geolocation.getCurrentPosition(
      p=>fetchWeatherByCoords(p.coords.latitude,p.coords.longitude).catch(ipFallback),
      _=>ipFallback(),
      {enableHighAccuracy:false,timeout:10000,maximumAge:300000}
    );
  });
  goBtn.addEventListener('click', ()=>fetchWeatherByCity(cityInput.value).catch(e=>content.innerHTML=`<div class="card error">${escapeHTML(e.message)}</div>`));
  cityInput.addEventListener('keydown', e=>{ if(e.key==='Enter') goBtn.click(); });
  unitToggle.addEventListener('click', ()=>{ unit = unit==='C' ? 'F' : 'C'; localStorage.setItem('unit', unit); applyUnit(); });
  themeToggle.addEventListener('click', ()=>{ theme = theme==='dark' ? 'light' : 'dark'; localStorage.setItem('theme', theme); applyTheme(); });
  langSelect.addEventListener('change', ()=>{
    lang = langSelect.value;
    localStorage.setItem('lang', lang);
    applyLang(); applyTheme(); // update button text language too
  });

  // --- Init
  langSelect.value = lang;
  applyLang();
  applyTheme();
  applyUnit();
  const last = localStorage.getItem('lastCity'); if(last) fetchWeatherByCity(last).catch(()=>{});
  </script>
</body>
</html>
