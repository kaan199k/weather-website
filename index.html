<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Weather</title>
  <meta name="description" content="Fast, simple weather app using the free Open-Meteo API (no key required)." />
  <link rel="preconnect" href="https://api.open-meteo.com" crossorigin>
  <link rel="preconnect" href="https://geocoding-api.open-meteo.com" crossorigin>
  <style>
    :root{
      --bg:#0b1020; --card:#111735; --muted:#98a2b3; --text:#e6eaf2; --accent:#6ea8fe; --accent-2:#b69bff; --danger:#ff6b6b; --input:#0f1530;
      --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f3f5fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --accent:#2563eb; --accent-2:#7c3aed; --danger:#dc2626; --input:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--text);
      background: radial-gradient(1200px 600px at 80% -10%, color-mix(in oklab, var(--accent) 25%, transparent), transparent 60%),
                  radial-gradient(1200px 600px at -10% 110%, color-mix(in oklab, var(--accent-2) 20%, transparent), transparent 60%),
                  var(--bg);
      display:grid; place-items:center; padding:24px; transition: background .3s ease, color .3s ease;
    }
    .app{ width:100%; max-width:820px; background:linear-gradient(180deg, color-mix(in oklab, #fff 4%, transparent), color-mix(in oklab, #fff 2%, transparent)); backdrop-filter: blur(10px); border:1px solid color-mix(in oklab, #fff 8%, transparent); border-radius: var(--radius); box-shadow: 0 30px 60px rgba(0,0,0,.35); overflow:hidden; }
    header{padding:26px 24px 0; display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .control-btn{ padding:10px 12px; border:none; border-radius:12px; font-weight:600; cursor:pointer; font-size:14px; background: var(--input); color:var(--text); border:1px solid color-mix(in oklab, #000 10%, #fff 10%); }
    .search{display:flex; gap:10px; padding:16px 24px 24px}
    input[type="text"]{ flex:1; background:var(--input); color:var(--text); border:1px solid color-mix(in oklab, #000 10%, #fff 10%); border-radius:12px; padding:14px 16px; outline:none; font-size:16px; }
    #go{padding:14px 16px; border:none; border-radius:12px; font-weight:600; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1020}
    #locate{padding:14px 16px; border:none; border-radius:12px; font-weight:600; background: var(--input); color:var(--text); border:1px solid color-mix(in oklab, #000 10%, #fff 10%)}
    .content{display:grid; gap:16px; padding:0 24px 24px}
    .card{background:color-mix(in oklab, #fff 3%, transparent); border:1px solid color-mix(in oklab, #fff 8%, transparent); border-radius:16px; padding:18px}
    .current{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .city{font-size:18px; opacity:.9}
    .temp{font-size:56px; font-weight:700; line-height:1}
    .meta{display:flex; gap:14px; flex-wrap:wrap; opacity:.9}
    .emoji{font-size:42px}
    .row{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    .kv{display:flex; align-items:center; gap:10px}
    .error{color:var(--danger); font-weight:600}
    .muted{color:var(--muted)}
    .loader{width:18px; height:18px; border:3px solid color-mix(in oklab, #fff 35%, transparent); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:600px){
      body{display:block; padding:16px; min-height:100dvh;}
      .app{max-width:100%; border-radius:14px;}
      header{padding:18px 16px 0;}
      .search{flex-direction:column; gap:8px; padding:12px 16px 16px;}
      #go,#locate{width:100%; padding:16px; font-size:16px;}
      .row{grid-template-columns:1fr 1fr;}
    }
    @media (max-width:380px){.row{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Quick Weather App">
    <header>
      <h1>Quick Weather</h1>
      <div class="controls">
        <button id="unitToggle" class="control-btn" title="Toggle ¬∞C/¬∞F">¬∞C</button>
        <!-- Shows CURRENT theme (Dark when dark, Light when light) -->
        <button id="themeToggle" class="control-btn" title="Toggle dark/light">Dark</button>
      </div>
    </header>

    <div class="search" role="search">
      <input id="city" type="text" placeholder="Search city... e.g. Sofia, Rome, Berlin" autocomplete="off" aria-label="City name" />
      <button id="go">Get Weather</button>
      <button id="locate" title="Use my location">Use My Location</button>
    </div>

    <section class="content" id="content" aria-live="polite">
      <div class="muted">Type a city and press <strong>Get Weather</strong>, or click <strong>Use My Location</strong>.</div>
    </section>
  </div>

  <script>
  const cityInput=document.getElementById('city');
  const goBtn=document.getElementById('go');
  const locateBtn=document.getElementById('locate');
  const content=document.getElementById('content');
  const unitToggle=document.getElementById('unitToggle');
  const themeToggle=document.getElementById('themeToggle');
  const htmlEl=document.documentElement;

  let unit=localStorage.getItem('unit')||'C';
  let theme=localStorage.getItem('theme')||'dark';
  let lastData=null;

  const codeMap={
    0:{d:'Clear sky',e:'‚òÄÔ∏è'},1:{d:'Mainly clear',e:'üå§Ô∏è'},2:{d:'Partly cloudy',e:'‚õÖ'},3:{d:'Overcast',e:'‚òÅÔ∏è'},
    45:{d:'Fog',e:'üå´Ô∏è'},48:{d:'Rime fog',e:'üå´Ô∏è'},51:{d:'Light drizzle',e:'üå¶Ô∏è'},53:{d:'Drizzle',e:'üå¶Ô∏è'},
    55:{d:'Heavy drizzle',e:'üåßÔ∏è'},56:{d:'Freezing drizzle',e:'ü•∂'},57:{d:'Freezing drizzle',e:'ü•∂'},
    61:{d:'Light rain',e:'üåßÔ∏è'},63:{d:'Rain',e:'üåßÔ∏è'},65:{d:'Heavy rain',e:'üåßÔ∏è'},66:{d:'Freezing rain',e:'ü•∂'},
    67:{d:'Freezing rain',e:'ü•∂'},71:{d:'Light snow',e:'üå®Ô∏è'},73:{d:'Snow',e:'üå®Ô∏è'},75:{d:'Heavy snow',e:'‚ùÑÔ∏è'},
    77:{d:'Snow grains',e:'‚ùÑÔ∏è'},80:{d:'Rain showers',e:'üå¶Ô∏è'},81:{d:'Heavy showers',e:'üåßÔ∏è'},
    82:{d:'Violent showers',e:'‚õàÔ∏è'},85:{d:'Snow showers',e:'üå®Ô∏è'},86:{d:'Heavy snow showers',e:'‚ùÑÔ∏è'},
    95:{d:'Thunderstorm',e:'‚õàÔ∏è'},96:{d:'Thunder w/ hail',e:'‚õàÔ∏è'},99:{d:'Thunder w/ hail',e:'‚õàÔ∏è'}
  };

  function escapeHTML(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));}
  const cToF=c=>c*9/5+32;
  const formatTemp=c=>unit==='C'?Math.round(c)+'¬∞C':Math.round(cToF(c))+'¬∞F';

  // >>> shows CURRENT theme text
  function applyTheme(){
    htmlEl.setAttribute('data-theme', theme);
    themeToggle.textContent = theme === 'dark' ? 'Dark' : 'Light';
  }
  function applyUnit(){
    unitToggle.textContent=unit==='C'?'¬∞C':'¬∞F';
    if(lastData)renderCurrent(lastData);
  }

  function setStatus(html){content.innerHTML=`<div class="card muted">${html}</div>`;}
  const degToCompass=d=>['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(d/22.5)%16];

  async function fetchAndRender({lat,lon,label}){
    const wxURL=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,wind_direction_10m&timezone=auto`;
    const wxRes=await fetch(wxURL);
    if(!wxRes.ok)throw new Error('Weather request failed.');
    const wx=await wxRes.json();
    const d={
      city:label,tz:wx.timezone_abbreviation,
      t:wx.current.temperature_2m,feels:wx.current.apparent_temperature,
      rh:wx.current.relative_humidity_2m,wc:wx.current.weather_code,
      wind:wx.current.wind_speed_10m,windd:wx.current.wind_direction_10m,
      precip:wx.current.precipitation,lat,lon
    };
    lastData=d;renderCurrent(d);
  }

  async function fetchWeatherByCity(city){
    if(!city||city.trim().length<2)throw new Error('Please enter a valid city.');
    setStatus(`Looking up ‚Äú${escapeHTML(city)}‚Äù‚Ä¶ <span class="loader"></span>`);
    const geoURL=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`;
    const r=await fetch(geoURL);
    if(!r.ok)throw new Error('Geocoding failed.');
    const j=await r.json();
    if(!j.results?.length)throw new Error('City not found. Try a different name.');
    const g=j.results[0];
    await fetchAndRender({lat:g.latitude,lon:g.longitude,label:`${g.name}${g.admin1?', '+g.admin1:''}${g.country?', '+g.country:''}`});
    localStorage.setItem('lastCity',g.name);
  }

  async function fetchWeatherByCoords(lat,lon){
    setStatus('Fetching weather for your location‚Ä¶ <span class="loader"></span>');
    let label='Your location';
    try{
      const rev=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en&format=json`);
      if(rev.ok){
        const j=await rev.json();
        if(j.results?.[0]){
          const r=j.results[0];
          label=`${r.name||'Your location'}${r.admin1?', '+r.admin1:''}${r.country?', '+r.country:''}`;
        }
      }
    }catch{}
    await fetchAndRender({lat,lon,label});
  }

  function renderCurrent(d){
    const code=codeMap[d.wc]||{d:'Unknown',e:'‚ùì'};
    content.innerHTML=`
      <div class="card current">
        <div>
          <div class="city">${escapeHTML(d.city)}</div>
          <div class="temp">${formatTemp(d.t)}</div>
          <div class="meta"><span>${code.d}</span><span>¬∑</span><span>${d.tz}</span></div>
        </div>
        <div class="emoji" aria-label="${code.d}">${code.e}</div>
      </div>
      <div class="row">
        <div class="card kv"><strong>Feels</strong> ${formatTemp(d.feels)}</div>
        <div class="card kv"><strong>Humidity</strong> ${Math.round(d.rh)}%</div>
        <div class="card kv"><strong>Precip</strong> ${d.precip.toFixed?d.precip.toFixed(1):d.precip} mm</div>
        <div class="card kv"><strong>Wind</strong> ${Math.round(d.wind)} km/h</div>
        <div class="card kv"><strong>Direction</strong> ${degToCompass(d.windd)} (${Math.round(d.windd)}¬∞)</div>
        <div class="card kv"><strong>Coords</strong> ${d.lat.toFixed(2)}, ${d.lon.toFixed(2)}</div>
      </div>`;
  }

  async function ipFallback(){
    try{
      setStatus('Trying approximate location via IP‚Ä¶ <span class="loader"></span>');
      const res=await fetch('https://ipapi.co/json/');
      if(!res.ok)throw new Error('IP location unavailable.');
      const j=await res.json();
      if(!j.latitude||!j.longitude)throw new Error('Could not detect location.');
      await fetchWeatherByCoords(j.latitude,j.longitude);
    }catch(e){
      content.innerHTML=`<div class="card error">Location error: ${escapeHTML(e.message)}</div>`;
    }
  }

  locateBtn.addEventListener('click',()=>{
    if(!navigator.geolocation)return content.innerHTML='<div class="card error">Geolocation not supported.</div>';
    navigator.geolocation.getCurrentPosition(
      p=>fetchWeatherByCoords(p.coords.latitude,p.coords.longitude).catch(ipFallback),
      _=>ipFallback(),
      {enableHighAccuracy:false,timeout:10000,maximumAge:300000}
    );
  });

  goBtn.addEventListener('click',()=>fetchWeatherByCity(cityInput.value).catch(e=>content.innerHTML=`<div class="card error">${escapeHTML(e.message)}</div>`));
  cityInput.addEventListener('keydown',e=>{if(e.key==='Enter')goBtn.click();});
  unitToggle.addEventListener('click',()=>{unit=unit==='C'?'F':'C';localStorage.setItem('unit',unit);applyUnit();});
  themeToggle.addEventListener('click',()=>{theme=theme==='dark'?'light':'dark';localStorage.setItem('theme',theme);applyTheme();});

  // init
  applyTheme(); // sets correct label (Dark/Light) based on saved theme
  applyUnit();
  const last=localStorage.getItem('lastCity'); if(last) fetchWeatherByCity(last).catch(()=>{});
  </script>
</body>
</html>
